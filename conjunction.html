<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿è¯ä¾¦æ¢ (Gemini å¢å¼ºç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; }
        .tab-btn { transition: all 0.2s ease-in-out; }
        .tab-btn.active { border-color: #3b82f6; background-color: #eff6ff; color: #2563eb; }
        .word { cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: background-color 0.2s; display: inline-block; }
        .word:hover { background-color: #e0e7ff; }
        .word.selected { background-color: #3b82f6; color: white; }
        .option-card { cursor: pointer; transition: all 0.2s ease-in-out; }
        .option-card:hover { transform: scale(1.03); border-color: #93c5fd; }
        .option-card.correct { border-color: #16a34a; background-color: #d1fae5; }
        .option-card.incorrect { border-color: #ef4444; background-color: #fee2e2; }
        .gemini-btn {
            background: linear-gradient(45deg, #4f46e5, #818cf8);
            border: none;
            color: white;
        }
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-2xl bg-white rounded-xl shadow-2xl p-6">
        <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">è¿è¯ä¾¦æ¢ (Gemini å¢å¼ºç‰ˆ)</h2>
        
        <!-- Tabs -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab-identify" class="tab-btn flex-1 py-3 px-4 font-semibold text-gray-500 border-b-2 border-transparent">ğŸ•µï¸ è¯†åˆ«æ¨¡å¼</button>
            <button id="tab-correct" class="tab-btn flex-1 py-3 px-4 font-semibold text-gray-500 border-b-2 border-transparent">âœï¸ çº é”™æ¨¡å¼</button>
        </div>

        <div id="game-container">
            <!-- Content will be injected here by JS -->
        </div>

        <!-- Gemini API Features Container -->
        <div id="gemini-features" class="mt-4 space-y-2"></div>
        <div id="gemini-response-container" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 hidden"></div>


        <div class="flex justify-between items-center mt-6">
            <p class="text-sm text-gray-500">åˆ†æ•°: <span id="score" class="font-bold">0</span></p>
            <button id="next-btn" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition opacity-0 pointer-events-none">ä¸‹ä¸€é¢˜</button>
        </div>
    </div>

    <script>
        const identifyQuestions = [
            { sentence: "He is rich, yet he is not happy.", conjunction: "yet", type: "å¹¶åˆ—è¿è¯", logic: "è½¬æŠ˜å…³ç³»" },
            { sentence: "I will call you when I get home.", conjunction: "when", type: "ä»å±è¿è¯", logic: "æ—¶é—´å…³ç³»" },
            { sentence: "Since you are here, you can help me.", conjunction: "since", type: "ä»å±è¿è¯", logic: "åŸå› å…³ç³»" },
            { sentence: "You can have either the coffee or the tea.", conjunction: ["either", "or"], type: "ç›¸å…³è¿è¯", logic: "é€‰æ‹©å…³ç³»" }
        ];

        const correctQuestions = [
            { sentence: "Although he was tired, but he kept working.", error: "Although ... but", options: ["Although he was tired, he kept working.", "He was tired, but he kept working.", "Both are correct."], answer: 0, correctSentence: "Although he was tired, he kept working." },
            { sentence: "He doesn't smoke, nor he drinks.", error: "nor he drinks", options: ["nor he does drink.", "nor does he drink.", "or he doesn't drink."], answer: 1, correctSentence: "He doesn't smoke, nor does he drink." },
            { sentence: "I didn't go to the party, because I was not invited.", error: "because", options: ["so I was not invited.", "for I was not invited.", "The sentence is correct."], answer: 2, correctSentence: "I didn't go to the party, for I was not invited." }
        ];

        let currentMode = 'identify';
        let currentQuestionIndex = 0;
        let score = 0;

        const tabIdentify = document.getElementById('tab-identify');
        const tabCorrect = document.getElementById('tab-correct');
        const gameContainer = document.getElementById('game-container');
        const scoreDisplay = document.getElementById('score');
        const nextBtn = document.getElementById('next-btn');
        const geminiFeaturesContainer = document.getElementById('gemini-features');
        const geminiResponseContainer = document.getElementById('gemini-response-container');

        // --- Gemini API Call ---
        async function callGemini(prompt, buttonElement) {
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = `<span class="loader"></span>`;
            buttonElement.disabled = true;
            geminiResponseContainer.classList.remove('hidden');
            geminiResponseContainer.innerHTML = 'æ€è€ƒä¸­...';

            const apiKey = ""; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    geminiResponseContainer.innerHTML = text.replace(/\n/g, '<br>');
                } else {
                    geminiResponseContainer.innerHTML = 'æŠ±æ­‰ï¼Œæ— æ³•è·å–å›å¤ã€‚è¯·é‡è¯•ã€‚';
                }
            } catch (error) {
                console.error("Gemini API call failed:", error);
                geminiResponseContainer.innerHTML = 'è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚';
            } finally {
                buttonElement.innerHTML = originalText;
                buttonElement.disabled = false;
            }
        }

        function showGeminiFeatures(isCorrect, correctSentence, incorrectSentence = '') {
            geminiFeaturesContainer.innerHTML = '';
            geminiResponseContainer.classList.add('hidden');

            if (isCorrect) {
                const expandBtn = document.createElement('button');
                expandBtn.innerHTML = 'âœ¨ å¸®æˆ‘ç»­å†™è¿™ä¸ªæ•…äº‹';
                expandBtn.className = 'gemini-btn w-full text-left p-3 rounded-lg font-semibold';
                expandBtn.onclick = () => {
                    const prompt = `Based on the sentence "${correctSentence}", continue the story with one more creative sentence. Use a different conjunction.`;
                    callGemini(prompt, expandBtn);
                };
                geminiFeaturesContainer.appendChild(expandBtn);
            } else {
                const explainBtn = document.createElement('button');
                explainBtn.innerHTML = 'âœ¨ ä¸ºä»€ä¹ˆé”™äº†ï¼Ÿ (Gemini è§£æ)';
                explainBtn.className = 'gemini-btn w-full text-left p-3 rounded-lg font-semibold';
                explainBtn.onclick = () => {
                    const prompt = `In simple Chinese, explain why the sentence "${incorrectSentence}" is grammatically incorrect, and why "${correctSentence}" is the correct version. Focus on the use of conjunctions.`;
                    callGemini(prompt, explainBtn);
                };
                geminiFeaturesContainer.appendChild(explainBtn);
            }
        }


        function switchMode(mode) {
            currentMode = mode;
            currentQuestionIndex = 0;
            score = 0;
            scoreDisplay.textContent = score;
            nextBtn.classList.add('opacity-0', 'pointer-events-none');
            geminiFeaturesContainer.innerHTML = '';
            geminiResponseContainer.classList.add('hidden');
            
            if (mode === 'identify') {
                tabIdentify.classList.add('active');
                tabCorrect.classList.remove('active');
                renderIdentifyMode();
            } else {
                tabCorrect.classList.add('active');
                tabIdentify.classList.remove('active');
                renderCorrectMode();
            }
        }

        function renderIdentifyMode() {
            const q = identifyQuestions[currentQuestionIndex];
            gameContainer.innerHTML = `
                <p class="text-center text-gray-600 mb-4">ç‚¹å‡»ä¸‹é¢å¥å­ä¸­çš„è¿è¯ï¼Œå¹¶é€‰æ‹©å®ƒçš„ç±»å‹ã€‚</p>
                <div id="sentence-box" class="text-2xl text-center p-4 bg-gray-50 rounded-lg mb-6"></div>
                <div id="identify-options" class="grid grid-cols-2 gap-4"></div>
                <p id="identify-feedback" class="text-center mt-4 font-semibold h-6"></p>
            `;
            const sentenceBox = document.getElementById('sentence-box');
            q.sentence.split(' ').forEach(word => {
                const wordSpan = document.createElement('span');
                wordSpan.textContent = word.replace(/[,.]/g, '');
                wordSpan.className = 'word';
                wordSpan.dataset.word = word.replace(/[,.]/g, '').toLowerCase();
                wordSpan.addEventListener('click', handleWordClick);
                sentenceBox.appendChild(wordSpan);
                sentenceBox.append(' ');
            });
            renderIdentifyOptions();
        }

        function handleWordClick(event) {
            const selectedWord = event.target;
            const isRelated = identifyQuestions[currentQuestionIndex].type === "ç›¸å…³è¿è¯";
            if (!isRelated) {
                document.querySelectorAll('.word.selected').forEach(w => w.classList.remove('selected'));
            }
            selectedWord.classList.toggle('selected');
        }

        function renderIdentifyOptions() {
            const options = [
                { type: "å¹¶åˆ—è¿è¯", logic: "è½¬æŠ˜å…³ç³»" },
                { type: "ä»å±è¿è¯", logic: "æ—¶é—´å…³ç³»" },
                { type: "ä»å±è¿è¯", logic: "åŸå› å…³ç³»" },
                { type: "ç›¸å…³è¿è¯", logic: "é€‰æ‹©å…³ç³»" }
            ];
            const optionsContainer = document.getElementById('identify-options');
            optionsContainer.innerHTML = '';
            options.forEach(opt => {
                const card = document.createElement('div');
                card.className = 'option-card border-2 border-gray-200 p-4 rounded-lg text-center';
                card.innerHTML = `<p class="font-bold">${opt.type}</p><p class="text-sm text-gray-500">${opt.logic}</p>`;
                card.onclick = () => checkIdentifyAnswer(opt, card);
                optionsContainer.appendChild(card);
            });
        }

        function checkIdentifyAnswer(selectedOpt, cardElement) {
            const q = identifyQuestions[currentQuestionIndex];
            const selectedWordElements = document.querySelectorAll('.word.selected');
            const selectedWords = Array.from(selectedWordElements).map(el => el.dataset.word);
            
            let isCorrect = false;
            if (Array.isArray(q.conjunction)) {
                isCorrect = selectedWords.length === q.conjunction.length && selectedWords.every(w => q.conjunction.includes(w));
            } else {
                isCorrect = selectedWords.length === 1 && selectedWords[0] === q.conjunction;
            }

            const feedback = document.getElementById('identify-feedback');
            if (isCorrect && selectedOpt.type === q.type && selectedOpt.logic === q.logic) {
                cardElement.classList.add('correct');
                feedback.textContent = 'å®Œå…¨æ­£ç¡®!';
                feedback.className = 'text-center mt-4 font-semibold h-6 text-green-600';
                score++;
                scoreDisplay.textContent = score;
                nextBtn.classList.remove('opacity-0', 'pointer-events-none');
                showGeminiFeatures(true, q.sentence);
            } else {
                cardElement.classList.add('incorrect');
                feedback.textContent = 'ä¸å¯¹å“¦ï¼Œå†æƒ³æƒ³ï¼';
                feedback.className = 'text-center mt-4 font-semibold h-6 text-red-600';
            }
        }

        function renderCorrectMode() {
            const q = correctQuestions[currentQuestionIndex];
            gameContainer.innerHTML = `
                <p class="text-center text-gray-600 mb-4">ä¸‹é¢è¿™å¥è¯æœ‰é€»è¾‘é”™è¯¯ï¼Œè¯·é€‰å‡ºæ­£ç¡®çš„å¥å­ã€‚</p>
                <div class="text-2xl text-center p-4 bg-red-50 text-red-700 rounded-lg mb-6">${q.sentence}</div>
                <div id="correct-options" class="space-y-3"></div>
                <p id="correct-feedback" class="text-center mt-4 font-semibold h-6"></p>
            `;
            const optionsContainer = document.getElementById('correct-options');
            q.options.forEach((opt, index) => {
                const card = document.createElement('div');
                card.className = 'option-card border-2 border-gray-200 p-4 rounded-lg';
                card.textContent = opt;
                card.onclick = () => checkCorrectAnswer(index, card);
                optionsContainer.appendChild(card);
            });
        }

        function checkCorrectAnswer(selectedIndex, cardElement) {
            const q = correctQuestions[currentQuestionIndex];
            const feedback = document.getElementById('correct-feedback');
            document.querySelectorAll('.option-card').forEach(c => c.onclick = null);

            if (selectedIndex === q.answer) {
                cardElement.classList.add('correct');
                feedback.textContent = 'å®Œå…¨æ­£ç¡®!';
                feedback.className = 'text-center mt-4 font-semibold h-6 text-green-600';
                score++;
                scoreDisplay.textContent = score;
                nextBtn.classList.remove('opacity-0', 'pointer-events-none');
                showGeminiFeatures(true, q.correctSentence);
            } else {
                cardElement.classList.add('incorrect');
                feedback.textContent = 'ä¸å¯¹å“¦ï¼Œå†æƒ³æƒ³ï¼';
                feedback.className = 'text-center mt-4 font-semibold h-6 text-red-600';
                showGeminiFeatures(false, q.correctSentence, q.sentence);
            }
        }

        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentMode === 'identify' && currentQuestionIndex >= identifyQuestions.length) {
                currentQuestionIndex = 0;
            } else if (currentMode === 'correct' && currentQuestionIndex >= correctQuestions.length) {
                currentQuestionIndex = 0;
            }
            nextBtn.classList.add('opacity-0', 'pointer-events-none');
            geminiFeaturesContainer.innerHTML = '';
            geminiResponseContainer.classList.add('hidden');
            if (currentMode === 'identify') {
                renderIdentifyMode();
            } else {
                renderCorrectMode();
            }
        });

        tabIdentify.addEventListener('click', () => switchMode('identify'));
        tabCorrect.addEventListener('click', () => switchMode('correct'));

        // Initial load
        switchMode('identify');
    </script>
</body>
</html>

